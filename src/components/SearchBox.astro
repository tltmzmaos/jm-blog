---

---

<div class="search-wrapper">
  <button
    class="search-trigger"
    type="button"
    aria-label="Search"
    id="search-trigger"
  >
    <svg
      width="20"
      height="20"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.35-4.35"></path>
    </svg>
  </button>

  <div
    class="search-modal"
    id="search-modal"
    role="dialog"
    aria-modal="true"
    aria-label="Search"
  >
    <div class="search-backdrop" id="search-backdrop"></div>
    <div class="search-panel">
      <div class="search-header">
        <svg
          class="header-icon"
          width="20"
          height="20"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <circle cx="11" cy="11" r="8"></circle>
          <path d="m21 21-4.35-4.35"></path>
        </svg>
        <input
          type="text"
          class="search-input"
          id="search-input"
          placeholder="Search posts..."
          autocomplete="off"
          spellcheck="false"
        />
        <kbd class="close-hint">ESC</kbd>
      </div>

      <div class="search-body" id="search-body">
        <div class="search-count" id="search-count"></div>
        <div class="search-results" id="search-results"></div>
        <div class="search-loading" id="search-loading">
          <div class="skeleton-item">
            <div class="skeleton-title"></div><div class="skeleton-desc"></div>
          </div>
          <div class="skeleton-item">
            <div class="skeleton-title short"></div><div class="skeleton-desc">
            </div>
          </div>
          <div class="skeleton-item">
            <div class="skeleton-title"></div><div class="skeleton-desc short">
            </div>
          </div>
        </div>
        <div class="search-empty" id="search-empty">
          <svg
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <p>Type to search posts</p>
        </div>
        <div class="search-no-results" id="search-no-results">
          <svg
            width="48"
            height="48"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.5"
          >
            <circle cx="12" cy="12" r="10"></circle>
            <path d="M8 15s1.5-2 4-2 4 2 4 2"></path>
            <line x1="9" y1="9" x2="9.01" y2="9"></line>
            <line x1="15" y1="9" x2="15.01" y2="9"></line>
          </svg>
          <p>No results found</p>
        </div>
      </div>

      <div class="search-footer">
        <div class="footer-hint">
          <kbd>↑</kbd><kbd>↓</kbd> Navigate
        </div>
        <div class="footer-hint">
          <kbd>↵</kbd> Open
        </div>
        <div class="footer-hint">
          <kbd>ESC</kbd> Close
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .search-wrapper {
    position: relative;
  }

  /* Trigger Button */
  .search-trigger {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem;
    color: #666;
    background: transparent;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition:
      color 0.15s,
      background 0.15s;
  }

  .search-trigger:hover {
    color: #1a1a1a;
    background: #f0f0f0;
  }

  :global(.dark) .search-trigger {
    color: #808080;
  }

  :global(.dark) .search-trigger:hover {
    color: #d4d4d4;
    background: #2a2d2e;
  }

  /* Modal */
  .search-modal {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 1000;
    padding: 10vh 1rem 1rem;
  }

  .search-modal.open {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    animation: fadeIn 0.15s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .search-backdrop {
    position: fixed;
    inset: 0;
    background: rgba(255, 255, 255, 0.6);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    transition:
      background 0.2s ease,
      backdrop-filter 0.2s ease;
  }

  :global(.dark) .search-backdrop {
    background: rgba(0, 0, 0, 0.6);
  }

  .search-panel {
    position: relative;
    width: 100%;
    max-width: 560px;
    max-height: 70vh;
    background: #fff;
    border-radius: 16px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    animation: slideUp 0.2s ease;
  }

  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(10px) scale(0.98);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  :global(.dark) .search-panel {
    background: #252526;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
  }

  /* Header */
  .search-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #e5e5e5;
  }

  :global(.dark) .search-header {
    border-bottom-color: #3c3c3c;
  }

  .header-icon {
    flex-shrink: 0;
    color: #0066ff;
  }

  :global(.dark) .header-icon {
    color: #569cd6;
  }

  .search-input {
    flex: 1;
    font-size: 1.125rem;
    font-weight: 500;
    color: #1a1a1a;
    background: transparent;
    border: none;
    outline: none;
  }

  :global(.dark) .search-input {
    color: #d4d4d4;
  }

  .search-input::placeholder {
    color: #999;
    font-weight: 400;
  }

  .close-hint {
    flex-shrink: 0;
    padding: 0.25rem 0.5rem;
    font-size: 0.6875rem;
    font-family: inherit;
    color: #888;
    background: #f0f0f0;
    border: none;
    border-radius: 4px;
  }

  :global(.dark) .close-hint {
    background: #2a2d2e;
    color: #808080;
  }

  /* Body */
  .search-body {
    flex: 1;
    overflow-y: auto;
    min-height: 200px;
  }

  .search-count {
    display: none;
    padding: 0.5rem 1.25rem;
    font-size: 0.75rem;
    color: #888;
    border-bottom: 1px solid #e5e5e5;
  }

  :global(.dark) .search-count {
    border-bottom-color: #3c3c3c;
  }

  .search-count.visible {
    display: block;
  }

  .search-results {
    display: none;
  }

  .search-results.has-results {
    display: block;
  }

  /* Loading Skeleton */
  .search-loading {
    display: none;
    padding: 0.5rem 0;
  }

  .search-body.loading .search-loading {
    display: block;
  }

  .search-body.loading .search-empty {
    display: none;
  }

  .skeleton-item {
    padding: 1rem 1.25rem;
    border-bottom: 1px solid #f0f0f0;
  }

  :global(.dark) .skeleton-item {
    border-bottom-color: #3c3c3c;
  }

  .skeleton-title,
  .skeleton-desc {
    height: 14px;
    border-radius: 4px;
    background: #e8e8e8;
    animation: shimmer 1.5s infinite;
  }

  :global(.dark) .skeleton-title,
  :global(.dark) .skeleton-desc {
    background: #333;
  }

  .skeleton-title {
    width: 70%;
    margin-bottom: 0.625rem;
  }

  .skeleton-title.short {
    width: 50%;
  }

  .skeleton-desc {
    width: 90%;
    height: 12px;
  }

  .skeleton-desc.short {
    width: 60%;
  }

  @keyframes shimmer {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.4;
    }
  }

  .search-empty,
  .search-no-results {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding: 3rem;
    color: #888;
  }

  .search-empty svg,
  .search-no-results svg {
    opacity: 0.3;
  }

  .search-empty p,
  .search-no-results p {
    font-size: 0.9375rem;
    margin: 0;
  }

  .search-no-results {
    display: none;
  }

  .search-body.no-results .search-empty {
    display: none;
  }

  .search-body.no-results .search-no-results {
    display: flex;
  }

  .search-body.has-query .search-empty {
    display: none;
  }

  /* Footer */
  .search-footer {
    display: flex;
    justify-content: center;
    gap: 1.5rem;
    padding: 0.75rem 1rem;
    border-top: 1px solid #e5e5e5;
    background: #fafafa;
  }

  :global(.dark) .search-footer {
    border-top-color: #3c3c3c;
    background: #1e1e1e;
  }

  .footer-hint {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    font-size: 0.75rem;
    color: #888;
  }

  .footer-hint kbd {
    padding: 0.125rem 0.375rem;
    font-size: 0.6875rem;
    font-family: inherit;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
  }

  :global(.dark) .footer-hint kbd {
    background: #2a2d2e;
    border-color: #3c3c3c;
  }

  /* Mobile */
  @media (max-width: 640px) {
    .search-modal {
      padding: 1rem;
    }

    .search-panel {
      max-height: 80vh;
    }

    .search-footer {
      display: none;
    }
  }
</style>

<script>
  import Fuse from 'fuse.js';

  interface Post {
    title: string;
    description: string;
    slug: string;
    tags: string[];
  }

  // State
  let postsData: Post[] = [];
  let fuse: Fuse<Post> | null = null;
  let selectedIndex = -1;
  let results: Post[] = [];

  // DOM elements
  const trigger = document.getElementById('search-trigger');
  const modal = document.getElementById('search-modal');
  const backdrop = document.getElementById('search-backdrop');
  const input = document.getElementById('search-input') as HTMLInputElement;
  const resultsContainer = document.getElementById('search-results');
  const searchBody = document.getElementById('search-body');
  const searchCount = document.getElementById('search-count');

  if (modal && modal.parentElement !== document.body) {
    document.body.appendChild(modal);
  }

  // Load posts data
  async function loadPosts() {
    if (postsData.length > 0) return;
    searchBody?.classList.add('loading');
    try {
      const response = await fetch('/api/posts.json');
      if (!response.ok) throw new Error('Failed to fetch posts');
      postsData = await response.json();
      fuse = new Fuse(postsData, {
        keys: [
          { name: 'title', weight: 2 },
          { name: 'description', weight: 1 },
          { name: 'tags', weight: 1.5 },
        ],
        threshold: 0.3,
      });
    } catch (error) {
      console.error('Search: Failed to load posts:', error);
    } finally {
      searchBody?.classList.remove('loading');
    }
  }

  // Escape HTML for XSS prevention
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
  }

  // Open modal
  function openModal() {
    modal?.classList.add('open');
    document.body.style.overflow = 'hidden';
    loadPosts();
    setTimeout(() => input?.focus(), 50);
  }

  // Close modal
  function closeModal() {
    modal?.classList.remove('open');
    document.body.style.overflow = '';
    if (input) input.value = '';
    if (resultsContainer) {
      resultsContainer.innerHTML = '';
      resultsContainer.classList.remove('has-results');
    }
    searchBody?.classList.remove('has-query', 'no-results');
    if (searchCount) {
      searchCount.textContent = '';
      searchCount.classList.remove('visible');
    }
    results = [];
    selectedIndex = -1;
  }

  // Render results
  function renderResults(items: Post[]) {
    results = items;
    selectedIndex = items.length > 0 ? 0 : -1;
    if (!resultsContainer) return;

    const isDark = document.documentElement.classList.contains('dark');
    const borderColor = isDark ? '#3c3c3c' : '#f0f0f0';
    const titleColor = isDark ? '#d4d4d4' : '#1a1a1a';
    const descColor = isDark ? '#808080' : '#666';

    resultsContainer.innerHTML = items
      .map((post, index) => {
        let tagsHtml = '';
        if (post.tags && post.tags.length) {
          tagsHtml =
            '<div style="display: flex; gap: 0.5rem; margin-top: 0.375rem;">' +
            post.tags
              .slice(0, 3)
              .map(
                (tag) =>
                  `<span style="font-size: 0.6875rem; padding: 0.125rem 0.375rem; background: ${isDark ? 'rgba(86, 156, 214, 0.15)' : '#e8f4ff'}; color: ${isDark ? '#569cd6' : '#0066ff'}; border-radius: 4px;">${escapeHtml(tag)}</span>`
              )
              .join('') +
            '</div>';
        }
        return `<a href="/posts/${post.slug}" class="search-result${index === 0 ? ' selected' : ''}" data-index="${index}" style="display: block; padding: 1rem 1.25rem; text-decoration: none; border-bottom: 1px solid ${borderColor}; transition: background 0.1s; background: ${index === 0 ? (isDark ? '#2a2d2e' : '#f5f5f5') : 'transparent'};">
        <div style="font-size: 0.9375rem; font-weight: 600; color: ${titleColor}; margin-bottom: 0.25rem;">${escapeHtml(post.title)}</div>
        <div style="font-size: 0.8125rem; color: ${descColor}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(post.description)}</div>
        ${tagsHtml}</a>`;
      })
      .join('');
  }

  // Update selection highlight
  function updateSelection() {
    if (!resultsContainer) return;
    const isDark = document.documentElement.classList.contains('dark');
    const items = resultsContainer.querySelectorAll('.search-result');
    items.forEach((el, i) => {
      const isSelected = i === selectedIndex;
      (el as HTMLElement).style.background = isSelected
        ? isDark
          ? '#2a2d2e'
          : '#f5f5f5'
        : 'transparent';
      if (isSelected) el.scrollIntoView({ block: 'nearest' });
    });
  }

  // Handle search
  function handleSearch(query: string) {
    if (!fuse || query.length < 2) {
      searchBody?.classList.remove('has-query', 'no-results');
      resultsContainer?.classList.remove('has-results');
      if (resultsContainer) resultsContainer.innerHTML = '';
      if (searchCount) {
        searchCount.textContent = '';
        searchCount.classList.remove('visible');
      }
      results = [];
      selectedIndex = -1;
      return;
    }

    searchBody?.classList.add('has-query');
    const found = fuse
      .search(query)
      .slice(0, 8)
      .map((r) => r.item);
    const totalFound = fuse.search(query).length;

    if (found.length > 0) {
      searchBody?.classList.remove('no-results');
      resultsContainer?.classList.add('has-results');
      if (searchCount) {
        searchCount.textContent =
          totalFound === 1 ? '1 result' : `${totalFound} results`;
        searchCount.classList.add('visible');
      }
      renderResults(found);
    } else {
      searchBody?.classList.add('no-results');
      resultsContainer?.classList.remove('has-results');
      if (resultsContainer) resultsContainer.innerHTML = '';
      if (searchCount) {
        searchCount.textContent = '';
        searchCount.classList.remove('visible');
      }
      results = [];
    }
  }

  // Event listeners
  trigger?.addEventListener('click', (e) => {
    e.preventDefault();
    e.stopPropagation();
    openModal();
  });

  backdrop?.addEventListener('click', closeModal);

  input?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value.trim();
    handleSearch(query);
  });

  input?.addEventListener('keydown', (e) => {
    if (results.length === 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, results.length - 1);
      updateSelection();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, 0);
      updateSelection();
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (selectedIndex >= 0 && results[selectedIndex]) {
        window.location.href = `/posts/${results[selectedIndex].slug}`;
      }
    }
  });

  // Global keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal?.classList.contains('open')) {
      closeModal();
    }
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (modal?.classList.contains('open')) {
        closeModal();
      } else {
        openModal();
      }
    }
  });

  // Click on result
  resultsContainer?.addEventListener('click', closeModal);
</script>
