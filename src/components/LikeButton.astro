---
export interface Props {
  postSlug: string;
}

const { postSlug } = Astro.props;

const githubToken = import.meta.env.PUBLIC_GITHUB_TOKEN;
const gistId = import.meta.env.PUBLIC_GIST_ID;
---

<button
  class="like-btn"
  data-slug={postSlug}
  data-github-token={githubToken}
  data-gist-id={gistId}
  type="button"
  aria-label="Like this post"
>
  <svg class="heart-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <path d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"/>
  </svg>
  <span class="count">-</span>
</button>

<style>
  .like-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    color: #666;
    background: #f5f5f5;
    border: 1px solid #e5e5e5;
    border-radius: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }

  :global(.dark) .like-btn {
    color: #888;
    background: #252526;
    border-color: #3c3c3c;
  }

  .like-btn:hover:not(:disabled) {
    color: #e53935;
    border-color: #e53935;
  }

  .like-btn.liked {
    color: #e53935;
    background: rgba(229, 57, 53, 0.1);
    border-color: #e53935;
  }

  .like-btn.liked .heart-icon {
    fill: #e53935;
  }

  .like-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .heart-icon {
    width: 18px;
    height: 18px;
    transition: transform 0.2s;
  }

  .like-btn:hover:not(:disabled) .heart-icon {
    transform: scale(1.1);
  }

  .like-btn.liked .heart-icon {
    animation: heartPop 0.3s ease;
  }

  @keyframes heartPop {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }

  .count {
    font-weight: 500;
    min-width: 1ch;
  }
</style>

<script>
  class GistLikeSystem {
    private githubToken: string;
    private gistId: string;
    private userId: string;

    constructor(githubToken: string, gistId: string) {
      this.githubToken = githubToken;
      this.gistId = gistId;
      this.userId = this.getOrCreateUserId();
    }

    private getOrCreateUserId(): string {
      try {
        let userId = localStorage.getItem('blog-user-id');
        if (!userId) {
          userId = 'user_' + Math.random().toString(36).substring(2, 11) + '_' + Date.now();
          localStorage.setItem('blog-user-id', userId);
        }
        return userId;
      } catch {
        return 'anonymous_' + Math.random().toString(36).substring(2, 11);
      }
    }

    async fetchGistData(): Promise<Record<string, { count: number; users: string[] }>> {
      if (!this.githubToken || !this.gistId) {
        return {};
      }

      try {
        const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
          headers: {
            'Authorization': `Bearer ${this.githubToken}`,
            'Accept': 'application/vnd.github.v3+json'
          }
        });

        if (!response.ok) {
          throw new Error(`GitHub API error: ${response.status}`);
        }

        const gist = await response.json();
        const content = gist.files['blog-likes.json']?.content || '{}';
        return JSON.parse(content);
      } catch (error) {
        console.error('Failed to fetch Gist data:', error);
        return {};
      }
    }

    async saveGistData(data: Record<string, { count: number; users: string[] }>): Promise<boolean> {
      if (!this.githubToken || !this.gistId) {
        return false;
      }

      try {
        const response = await fetch(`https://api.github.com/gists/${this.gistId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `Bearer ${this.githubToken}`,
            'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            files: {
              'blog-likes.json': {
                content: JSON.stringify(data, null, 2)
              }
            }
          })
        });

        return response.ok;
      } catch (error) {
        console.error('Failed to save Gist data:', error);
        return false;
      }
    }

    async getPostLikes(postSlug: string): Promise<{ count: number; isLiked: boolean }> {
      if (!postSlug) {
        return { count: 0, isLiked: false };
      }

      const data = await this.fetchGistData();
      let postData = data[postSlug];

      if (typeof postData === 'number') {
        postData = { count: postData, users: [] };
      } else if (!postData) {
        postData = { count: 0, users: [] };
      }

      return {
        count: postData.count || 0,
        isLiked: postData.users ? postData.users.includes(this.userId) : false
      };
    }

    async toggleLike(postSlug: string): Promise<{ count: number; isLiked: boolean }> {
      if (!postSlug) {
        throw new Error('Invalid postSlug');
      }

      const data = await this.fetchGistData();

      let postData = data[postSlug];
      if (typeof postData === 'number') {
        postData = { count: postData, users: [] };
      } else if (!postData) {
        postData = { count: 0, users: [] };
      }

      const isCurrentlyLiked = postData.users && postData.users.includes(this.userId);

      if (isCurrentlyLiked) {
        postData.count = Math.max(0, postData.count - 1);
        postData.users = postData.users.filter((id: string) => id !== this.userId);
      } else {
        postData.count = postData.count + 1;
        if (!postData.users) postData.users = [];
        postData.users.push(this.userId);
      }

      data[postSlug] = postData;

      const success = await this.saveGistData(data);

      if (success) {
        return {
          count: postData.count,
          isLiked: !isCurrentlyLiked
        };
      } else {
        throw new Error('Failed to save like');
      }
    }

    isConfigured(): boolean {
      return !!(this.githubToken && this.gistId &&
                this.githubToken !== 'undefined' && this.gistId !== 'undefined');
    }
  }

  async function initLikeButtons() {
    const buttons = document.querySelectorAll<HTMLButtonElement>('.like-btn');

    buttons.forEach(async (btn) => {
      const slug = btn.dataset.slug;
      const githubToken = btn.dataset.githubToken || '';
      const gistId = btn.dataset.gistId || '';
      const countEl = btn.querySelector('.count')!;

      if (!slug) {
        btn.disabled = true;
        countEl.textContent = '0';
        return;
      }

      const likeSystem = new GistLikeSystem(githubToken, gistId);

      if (!likeSystem.isConfigured()) {
        btn.disabled = true;
        btn.title = 'Like feature is not configured';
        countEl.textContent = '0';
        return;
      }

      let isLoading = false;

      // Fetch initial state
      try {
        const { count, isLiked } = await likeSystem.getPostLikes(slug);
        countEl.textContent = String(count);
        if (isLiked) btn.classList.add('liked');
      } catch {
        countEl.textContent = '0';
      }

      // Handle click
      btn.addEventListener('click', async () => {
        if (isLoading) return;
        isLoading = true;
        btn.disabled = true;

        try {
          const { count, isLiked } = await likeSystem.toggleLike(slug);
          countEl.textContent = String(count);
          btn.classList.toggle('liked', isLiked);
        } catch (error) {
          console.error('Like toggle failed:', error);
        } finally {
          isLoading = false;
          btn.disabled = false;
        }
      });
    });
  }

  document.addEventListener('astro:page-load', initLikeButtons);
</script>
