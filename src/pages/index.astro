---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import PostListItem from '../components/PostListItem.astro';
import { shouldShowDrafts } from '../utils/env';

const showDrafts = shouldShowDrafts();
const allPosts = await getCollection('blog');
const sortedPosts = allPosts
  .filter(post => showDrafts || !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const INITIAL_COUNT = 10;
---

<BaseLayout title="Jongmin's Dev Blog" description="Sharing development experiences and technical insights">
  <Header />

  <main class="main-content">
    <section class="posts" id="posts">
      {sortedPosts.map((post, i) => (
        <div class:list={['post-wrapper', { hidden: i >= INITIAL_COUNT }]}>
          <PostListItem
            title={post.data.title}
            description={post.data.description}
            pubDate={post.data.pubDate}
            heroImage={post.data.heroImage}
            slug={post.slug}
            tags={post.data.tags}
          />
        </div>
      ))}

      {sortedPosts.length === 0 && (
        <p class="empty">No posts yet.</p>
      )}
    </section>

    {sortedPosts.length > INITIAL_COUNT && (
      <div class="load-more" id="load-sentinel">
        <span class="load-text">Scroll for more</span>
      </div>
    )}
  </main>
</BaseLayout>

<noscript>
  <style>
    .post-wrapper.hidden { display: block !important; }
    .load-more { display: none !important; }
  </style>
</noscript>

<style>
  .main-content {
    max-width: 720px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  .posts {
    display: flex;
    flex-direction: column;
  }

  .post-wrapper.hidden {
    display: none;
  }

  .post-wrapper.reveal {
    animation: fadeIn 0.3s ease forwards;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .load-more {
    text-align: center;
    padding: 2rem 0 1rem;
  }

  .load-text {
    font-size: 0.8125rem;
    color: #999;
  }

  .load-more.done {
    display: none;
  }

  .empty {
    text-align: center;
    color: #888;
    padding: 3rem 0;
  }

  @media (max-width: 640px) {
    .main-content {
      padding: 1.5rem 1rem;
    }
  }
</style>

<script>
  document.addEventListener('astro:page-load', () => {
    const sentinel = document.getElementById('load-sentinel');
    if (!sentinel) return;

    const posts = document.querySelectorAll<HTMLElement>('.post-wrapper');
    const BATCH = 10;
    let shown = 0;

    // Count initially visible posts
    posts.forEach(p => { if (!p.classList.contains('hidden')) shown++; });

    if (shown >= posts.length) {
      sentinel.classList.add('done');
      return;
    }

    const observer = new IntersectionObserver((entries) => {
      if (!entries[0].isIntersecting) return;

      let revealed = 0;
      for (let i = shown; i < posts.length && revealed < BATCH; i++) {
        posts[i].classList.remove('hidden');
        posts[i].classList.add('reveal');
        revealed++;
      }
      shown += revealed;

      if (shown >= posts.length) {
        sentinel.classList.add('done');
        observer.disconnect();
      }
    }, { rootMargin: '200px' });

    observer.observe(sentinel);

    // Cleanup on page swap
    document.addEventListener('astro:before-swap', () => observer.disconnect(), { once: true });
  });
</script>
