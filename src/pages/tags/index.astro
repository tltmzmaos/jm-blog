---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import { shouldShowDrafts } from '../../utils/env';

const showDrafts = shouldShowDrafts();
const allPosts = await getCollection('blog');
const publishedPosts = allPosts
  .filter((post) => showDrafts || !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const tagCounts = publishedPosts.reduce(
  (acc, post) => {
    post.data.tags.forEach((tag) => {
      acc[tag] = (acc[tag] || 0) + 1;
    });
    return acc;
  },
  {} as Record<string, number>
);

// Alphabetical order, but weight still based on popularity
const sortedTags = Object.entries(tagCounts)
  .sort(([a], [b]) => a.localeCompare(b))
  .map(([tag, count]) => ({ tag, count }));

const maxCount = Math.max(...sortedTags.map((t) => t.count), 1);
const baseUrl = import.meta.env.BASE_URL;
---

<BaseLayout title="Tags - Jongmin's Dev Blog" description="Browse all tags">
  <Header />

  <main class="main-content" id="main-content">
    <div class="page-header">
      <h1>Tags</h1>
    </div>

    <div class="search-box">
      <svg
        class="search-icon"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
      <input
        type="text"
        id="tag-search"
        placeholder="Filter tags..."
        autocomplete="off"
      />
      <kbd class="shortcut">/</kbd>
    </div>

    <div class="tag-cloud" id="tag-cloud">
      {
        sortedTags.map(({ tag, count }, i) => {
          const w = count / maxCount;
          return (
            <a
              href={`${baseUrl}tags/${encodeURIComponent(tag)}`}
              class="tag"
              data-tag={tag.toLowerCase()}
              style={`--w: ${w}; --d: ${i * 20}ms`}
            >
              {tag}
              <span class="count">{count}</span>
            </a>
          );
        })
      }
    </div>
  </main>
</BaseLayout>

<script>
  document.addEventListener('astro:page-load', () => {
    const cloud = document.getElementById('tag-cloud');
    const searchInput = document.getElementById(
      'tag-search'
    ) as HTMLInputElement | null;
    const tags = cloud?.querySelectorAll<HTMLElement>('.tag');
    if (!cloud || !tags?.length) return;

    // Hover dim: when any tag is hovered, dim the rest
    cloud.addEventListener('mouseover', (e) => {
      const target = (e.target as HTMLElement).closest('.tag');
      if (target) cloud.classList.add('has-hover');
    });
    cloud.addEventListener('mouseout', (e) => {
      const target = (e.target as HTMLElement).closest('.tag');
      if (target) cloud.classList.remove('has-hover');
    });

    // Search
    function filterTags(q: string) {
      const query = q.toLowerCase().trim();
      for (const el of tags!) {
        const tag = el.dataset.tag || '';
        el.classList.toggle(
          'filtered',
          query.length > 0 && !tag.includes(query)
        );
      }
    }

    if (searchInput) {
      searchInput.addEventListener('input', () => {
        filterTags(searchInput.value);
      });
    }

    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput?.focus();
      }
      if (e.key === 'Escape' && searchInput) {
        searchInput.value = '';
        searchInput.blur();
        filterTags('');
      }
    });
  });
</script>

<style>
  .main-content {
    max-width: 720px;
    margin: 0 auto;
    padding: 3rem 1.5rem 4rem;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .page-header h1 {
    font-size: 2rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0;
    letter-spacing: -0.03em;
  }

  /* ═══ Search ═══ */
  .search-box {
    position: relative;
    margin-bottom: 2.5rem;
  }

  .search-icon {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    pointer-events: none;
    transition: color 0.15s;
  }

  .search-box:has(#tag-search:focus) .search-icon {
    color: var(--color-accent);
  }

  #tag-search {
    width: 100%;
    padding: 0.5rem 2rem 0.5rem 1.625rem;
    font-size: 0.875rem;
    font-family: inherit;
    color: var(--color-text);
    background: transparent;
    border: none;
    border-bottom: 1px solid var(--color-border-light);
    border-radius: 0;
    outline: none;
    transition: border-color 0.15s;
  }

  #tag-search::placeholder {
    color: var(--color-text-muted);
  }

  #tag-search:focus {
    border-color: var(--color-accent);
  }

  .shortcut {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    padding: 0.125rem 0.375rem;
    font-size: 0.6875rem;
    font-family: inherit;
    color: var(--color-text-muted);
    background: var(--color-border-light);
    border-radius: 4px;
    pointer-events: none;
    transition: opacity 0.15s;
  }

  #tag-search:focus ~ .shortcut {
    opacity: 0;
  }

  /* ═══ Tag Cloud ═══ */
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: 0.25rem 0.625rem;
    line-height: 1.6;
  }

  .tag {
    position: relative;
    text-decoration: none;
    color: var(--color-text);
    white-space: nowrap;

    /* Size & weight driven by --w (0..1) */
    font-size: calc(0.875rem + 1rem * var(--w));
    font-weight: calc(400 + 300 * var(--w));
    letter-spacing: calc(-0.005em - 0.02em * var(--w));

    /* Entry */
    opacity: 0;
    animation: fade-in 0.3s ease-out forwards;
    animation-delay: var(--d);

    /* Hover */
    transition:
      color 0.3s,
      opacity 0.3s,
      transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Underline that grows on hover */
  .tag::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: -3px;
    width: 0;
    height: 1.5px;
    background: var(--color-accent);
    transition: width 0.35s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .tag:hover {
    color: var(--color-accent);
    transform: translateX(3px);
  }

  .tag:hover::after {
    width: 100%;
  }

  /* Dim siblings on hover */
  .tag-cloud.has-hover .tag {
    opacity: 0.35;
  }

  .tag-cloud.has-hover .tag:hover {
    opacity: 1;
  }

  .tag.filtered {
    opacity: 0.04 !important;
    pointer-events: none;
  }

  /* Count — appears on hover */
  .count {
    display: inline-block;
    font-size: 0.6875rem;
    font-weight: 400;
    color: var(--color-text-muted);
    vertical-align: super;
    margin-left: 0.1875rem;
    opacity: 0;
    transform: translateY(4px) scale(0.9);
    transition:
      opacity 0.2s 0.05s,
      transform 0.25s 0.05s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .tag:hover .count {
    opacity: 1;
    transform: translateY(0) scale(1);
  }

  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* ═══ Responsive ═══ */
  @media (max-width: 640px) {
    .main-content {
      padding: 2rem 1rem 3rem;
    }

    .page-header h1 {
      font-size: 1.75rem;
    }

    .tag {
      font-size: calc(0.8125rem + 0.75rem * var(--w));
    }

    .tag-cloud {
      gap: 0.1875rem 0.5rem;
    }
  }
</style>
