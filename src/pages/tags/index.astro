---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import { shouldShowDrafts } from '../../utils/env';

const showDrafts = shouldShowDrafts();
const allPosts = await getCollection('blog');
const publishedPosts = allPosts
  .filter(post => showDrafts || !post.data.draft)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const tagCounts = publishedPosts.reduce((acc, post) => {
  post.data.tags.forEach(tag => {
    acc[tag] = (acc[tag] || 0) + 1;
  });
  return acc;
}, {} as Record<string, number>);

const sortedTags = Object.entries(tagCounts)
  .sort(([,a], [,b]) => b - a)
  .map(([tag, count]) => ({ tag, count }));

const maxCount = sortedTags[0]?.count || 1;
const minCount = sortedTags[sortedTags.length - 1]?.count || 1;

function getTagWeight(count: number): 'sm' | 'md' | 'lg' {
  if (maxCount === minCount) return 'md';
  const ratio = (count - minCount) / (maxCount - minCount);
  if (ratio > 0.6) return 'lg';
  if (ratio > 0.2) return 'md';
  return 'sm';
}

const baseUrl = import.meta.env.BASE_URL;
---

<BaseLayout title="Tags - Jongmin's Dev Blog" description="Browse all tags">
  <Header />

  <main class="main-content">
    <div class="page-header">
      <div class="header-row">
        <h1>Tags</h1>
        <span class="tag-total">{sortedTags.length} tags</span>
      </div>
      <div class="search-box">
        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
        <input
          type="text"
          id="tag-search"
          placeholder="Filter tags..."
          autocomplete="off"
        />
        <kbd class="shortcut">/</kbd>
      </div>
    </div>

    <div class="no-results" hidden>
      No tags found
    </div>

    <div class="tag-cloud">
      {sortedTags.map(({ tag, count }) => (
        <a
          href={`${baseUrl}tags/${encodeURIComponent(tag)}`}
          class:list={['tag', `tag-${getTagWeight(count)}`]}
          data-tag={tag.toLowerCase()}
        >
          <span class="tag-name">{tag}</span>
          <span class="tag-count">{count}</span>
        </a>
      ))}
    </div>
  </main>

  <script>
    const searchInput = document.getElementById('tag-search') as HTMLInputElement;
    const tags = document.querySelectorAll('.tag');
    const noResults = document.querySelector('.no-results') as HTMLElement;

    // Focus on "/" key
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && document.activeElement !== searchInput) {
        e.preventDefault();
        searchInput.focus();
      }
      if (e.key === 'Escape') {
        searchInput.value = '';
        searchInput.blur();
        filterTags('');
      }
    });

    function filterTags(query: string) {
      const q = query.toLowerCase().trim();
      let visibleCount = 0;

      tags.forEach(tag => {
        const tagName = tag.getAttribute('data-tag') || '';
        const matches = !q || tagName.includes(q);
        (tag as HTMLElement).style.display = matches ? '' : 'none';
        if (matches) visibleCount++;
      });

      noResults.hidden = visibleCount > 0;
    }

    searchInput.addEventListener('input', (e) => {
      filterTags((e.target as HTMLInputElement).value);
    });
  </script>
</BaseLayout>

<style>
  .main-content {
    max-width: 720px;
    margin: 0 auto;
    padding: 3rem 1.5rem;
  }

  .page-header {
    margin-bottom: 2rem;
  }

  .header-row {
    display: flex;
    align-items: baseline;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .page-header h1 {
    font-size: 1.5rem;
    font-weight: 600;
    color: #1a1a1a;
    margin: 0;
    letter-spacing: -0.02em;
  }

  :global(.dark) .page-header h1 {
    color: #e5e5e5;
  }

  .tag-total {
    font-size: 0.8125rem;
    color: #888;
    font-weight: 400;
  }

  /* Search Box */
  .search-box {
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-icon {
    position: absolute;
    left: 0.75rem;
    color: #999;
    pointer-events: none;
  }

  #tag-search {
    width: 100%;
    padding: 0.625rem 2.5rem 0.625rem 2.25rem;
    font-size: 0.875rem;
    font-family: inherit;
    color: #333;
    background: #f5f5f5;
    border: 1px solid transparent;
    border-radius: 8px;
    outline: none;
    transition: all 0.15s;
  }

  #tag-search::placeholder {
    color: #999;
  }

  #tag-search:focus {
    background: #fff;
    border-color: #ddd;
    box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
  }

  :global(.dark) #tag-search {
    color: #e5e5e5;
    background: #252525;
  }

  :global(.dark) #tag-search:focus {
    background: #1a1a1a;
    border-color: #444;
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.05);
  }

  .shortcut {
    position: absolute;
    right: 0.625rem;
    padding: 0.125rem 0.375rem;
    font-size: 0.6875rem;
    font-family: inherit;
    color: #999;
    background: #e8e8e8;
    border-radius: 4px;
    pointer-events: none;
  }

  :global(.dark) .shortcut {
    background: #333;
    color: #777;
  }

  #tag-search:focus ~ .shortcut {
    display: none;
  }

  /* Tag Cloud */
  .tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    align-items: center;
  }

  .tag {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    text-decoration: none;
    color: #444;
    background: #f5f5f5;
    border-radius: 6px;
    transition: all 0.15s;
  }

  /* Size variants */
  .tag-sm {
    padding: 0.3rem 0.6rem;
    font-size: 0.75rem;
  }

  .tag-md {
    padding: 0.4rem 0.7rem;
    font-size: 0.8125rem;
  }

  .tag-lg {
    padding: 0.5rem 0.85rem;
    font-size: 0.9375rem;
    font-weight: 600;
  }

  :global(.dark) .tag {
    color: #ccc;
    background: #252525;
  }

  .tag:hover {
    background: #e8e8e8;
    color: #000;
  }

  :global(.dark) .tag:hover {
    background: #333;
    color: #fff;
  }

  .tag-name {
    font-weight: 500;
  }

  .tag-lg .tag-name {
    font-weight: 600;
  }

  .tag-count {
    font-size: 0.6875rem;
    font-weight: 600;
    color: #888;
    background: rgba(0, 0, 0, 0.06);
    padding: 0.0625rem 0.3125rem;
    border-radius: 4px;
  }

  .tag-sm .tag-count {
    font-size: 0.625rem;
  }

  :global(.dark) .tag-count {
    background: rgba(255, 255, 255, 0.08);
    color: #777;
  }

  .no-results {
    text-align: center;
    color: #888;
    padding: 3rem 0;
    font-size: 0.9375rem;
  }

  @media (max-width: 640px) {
    .main-content {
      padding: 2rem 1rem;
    }

    .page-header h1 {
      font-size: 1.25rem;
    }

    .tag-sm {
      padding: 0.25rem 0.4375rem;
      font-size: 0.6875rem;
    }

    .tag-md {
      padding: 0.3125rem 0.5rem;
      font-size: 0.75rem;
    }

    .tag-lg {
      padding: 0.375rem 0.625rem;
      font-size: 0.8125rem;
    }

    .tag-count {
      font-size: 0.625rem;
    }
  }
</style>
