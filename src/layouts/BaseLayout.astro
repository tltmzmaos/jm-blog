---
import { ClientRouter } from 'astro:transitions';
import SEO from '../components/SEO.astro';

export interface Props {
  title: string;
  description?: string;
  image?: string;
  type?: 'website' | 'article';
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  author?: string;
  hasMath?: boolean;
  slug?: string;
}

const {
  title,
  description = "Jongmin's Dev Blog",
  image = '/og-image.jpg',
  type = 'website',
  publishedTime,
  modifiedTime,
  tags,
  author,
  hasMath = false,
  slug,
} = Astro.props;
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/logo.svg" />
    <meta name="generator" content={Astro.generator} />
    <meta name="color-scheme" content="light dark" />
    <meta
      name="theme-color"
      content="#ffffff"
      media="(prefers-color-scheme: light)"
    />
    <meta
      name="theme-color"
      content="#1e1e1e"
      media="(prefers-color-scheme: dark)"
    />

    <!-- DNS Prefetch for external resources -->
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

    <!-- SEO -->
    <SEO
      title={title}
      description={description}
      image={image}
      type={type}
      publishedTime={publishedTime}
      modifiedTime={modifiedTime}
      tags={tags}
      author={author}
      slug={slug}
    />

    <!-- KaTeX CSS (only loaded on pages with math) -->
    {
      hasMath && (
        <link
          rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"
          crossorigin="anonymous"
        />
      )
    }

    <title>{title}</title>

    <ClientRouter />

    <!-- Prevent dark mode flash -->
    <script is:inline>
      (function () {
        const theme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia(
          '(prefers-color-scheme: dark)'
        ).matches;

        if (theme === 'dark' || (!theme && prefersDark)) {
          document.documentElement.classList.add('dark');
          document.documentElement.style.colorScheme = 'dark';
        }

        // Preserve theme across View Transitions page swaps
        document.addEventListener('astro:before-swap', (e) => {
          const t = localStorage.getItem('theme');
          const dark =
            t === 'dark' ||
            (!t && window.matchMedia('(prefers-color-scheme: dark)').matches);
          e.newDocument.documentElement.classList.toggle('dark', dark);
          e.newDocument.documentElement.style.colorScheme = dark
            ? 'dark'
            : 'light';
        });

        window
          .matchMedia('(prefers-color-scheme: dark)')
          .addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
              document.documentElement.classList.toggle('dark', e.matches);
              document.documentElement.style.colorScheme = e.matches
                ? 'dark'
                : 'light';
            }
          });
      })();
    </script>
  </head>

  <body>
    <a href="#main-content" class="skip-to-content">Skip to content</a>
    <slot />

    <!-- Cloudflare Web Analytics -->
    <script is:inline>
      (function () {
        function load() {
          var s = document.createElement('script');
          s.src = 'https://static.cloudflareinsights.com/beacon.min.js';
          s.dataset.cfBeacon = '{"token": "7b9d87031cae435d91c599cde69e59ec"}';
          document.body.appendChild(s);
        }
        if ('requestIdleCallback' in window) {
          requestIdleCallback(load);
        } else {
          setTimeout(load, 2000);
        }
      })();
    </script>
  </body>
</html>

<style is:global>
  @font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 400;
    font-display: swap;
    src: url('/fonts/inter-latin-400.woff2') format('woff2');
    unicode-range:
      U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC,
      U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191,
      U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }

  @font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 500;
    font-display: swap;
    src: url('/fonts/inter-latin-500.woff2') format('woff2');
    unicode-range:
      U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC,
      U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191,
      U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }

  @font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 600;
    font-display: swap;
    src: url('/fonts/inter-latin-600.woff2') format('woff2');
    unicode-range:
      U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC,
      U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191,
      U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }

  @font-face {
    font-family: 'Inter';
    font-style: normal;
    font-weight: 700;
    font-display: swap;
    src: url('/fonts/inter-latin-700.woff2') format('woff2');
    unicode-range:
      U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC,
      U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191,
      U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  :root {
    --color-bg: #ffffff;
    --color-bg-secondary: #f5f5f5;
    --color-bg-tertiary: #fafafa;
    --color-text: #1a1a1a;
    --color-text-secondary: #666666;
    --color-text-muted: #888888;
    --color-border: #e5e5e5;
    --color-border-light: #f0f0f0;
    --color-accent: #0066ff;
    --color-accent-hover: #0052cc;
    --color-code-bg: #1e1e1e;
    --color-code-border: #3c3c3c;
  }

  .dark {
    --color-bg: #1e1e1e;
    --color-bg-secondary: #252526;
    --color-bg-tertiary: #2a2d2e;
    --color-text: #d4d4d4;
    --color-text-secondary: #808080;
    --color-text-muted: #888888;
    --color-border: #3c3c3c;
    --color-border-light: #333333;
    --color-accent: #58a6ff;
    --color-accent-hover: #79b8ff;
    --color-code-bg: #1e1e1e;
    --color-code-border: #3c3c3c;
  }

  html {
    scroll-behavior: smooth;
  }

  body {
    font-family:
      'Inter',
      -apple-system,
      BlinkMacSystemFont,
      'Segoe UI',
      Roboto,
      sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    background: var(--color-bg);
    color: var(--color-text);
    line-height: 1.6;
    transition:
      background-color 0.2s ease,
      color 0.2s ease;
  }

  /* Dark mode transition animation */
  .theme-transition,
  .theme-transition *,
  .theme-transition *::before,
  .theme-transition *::after {
    transition:
      background-color 0.2s ease,
      color 0.2s ease,
      border-color 0.2s ease,
      fill 0.2s ease,
      stroke 0.2s ease !important;
  }

  a {
    color: inherit;
    text-decoration: none;
  }

  img {
    max-width: 100%;
    height: auto;
  }

  /* Selection styles */
  ::selection {
    background: var(--color-accent);
    color: #fff;
  }

  .dark ::selection {
    background: #264f78;
    color: #ffffff;
  }

  /* Skip to content link */
  .skip-to-content {
    position: fixed;
    top: -100%;
    left: 1rem;
    z-index: 999;
    padding: 0.75rem 1.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: #fff;
    background: var(--color-accent);
    border-radius: 0 0 8px 8px;
    text-decoration: none;
    transition: top 0.2s ease;
  }

  .skip-to-content:focus {
    top: 0;
    outline: none;
  }

  /* Focus styles */
  :focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }

  ::-webkit-scrollbar-track {
    background: var(--color-bg-secondary);
  }

  ::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
  }

  ::-webkit-scrollbar-thumb:hover {
    background: #999;
  }

  .dark ::-webkit-scrollbar-thumb {
    background: var(--color-border);
  }

  .dark ::-webkit-scrollbar-thumb:hover {
    background: #4f4f4f;
  }

  /* Code blocks */
  .dark pre[class*='language-'],
  .dark .shiki {
    background: #1e1e1e !important;
    border: 1px solid #3c3c3c !important;
  }

  .dark code[class*='language-'],
  .dark .shiki code {
    color: #d4d4d4 !important;
  }

  /* Reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
      animation-duration: 0.01ms !important;
      transition-duration: 0.01ms !important;
      scroll-behavior: auto !important;
    }
  }
</style>
